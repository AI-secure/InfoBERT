# InfoBERT on ANLI

## Prepare your data
Download the [training data and test data](https://drive.google.com/file/d/1xWwABFkzJ6fEnR1f3xr-vkMesxdO7IZm/view?usp=sharing) into `anli_data`. 
The training data includes:

- ANLI(train)
- MNLI
- SNLI
- FeverNLI

The testing data includes:
- ANLI(dev/test)
- MNLI
- SNLI
- adversarial MNLI dataset generated by TextFooler against BERT and RoBERTa (`infobert_mnli_matched`, `infobert_mnli_mismatched`, `roberta_mnli_matched`, `roberta_mnli_mismatched`)
- adversarial SNLI dataset generated by TextFooler against BERT and RoBERTa (`infobert_snli`, `roberta_snli`)

After unzip the data, the directory strcucture should look like:
```
anli_data
├── MNLI
├── SNLI
├── infobert_mnli_matched
├── infobert_mnli_mismatched
├── infobert_snli
├── nli_fever
├── roberta_mnli_matched
├── roberta_mnli_mismatched
└── roberta_snli

```

Note that the ANLI dataset will be automatically downloaded by `nlp` package during training/testing.

## Train

Running example:
```bash
#                             [task-name]  [custom-name]    [base-model]           [lr]  [batch-size]  [max-seq-len]     [training-steps]  [warmup steps]    [seed]    [weight-decay]   [beta]    [mi_version]  [hdp] [adp]    [adv lr]    [adv mag]  [anorm]  [asteps]   [alpha]    [cl]    [ch]
source setup.sh && runexp      anli-full      infobert     roberta-large          2e-5        32             128              -1                1000          42           1e-5         5e-3            6       0.1    0       4e-2         8e-2        0        3         5e-3      0.5     0.9
```

Detailed explanation of each parameter can be found in `setup.sh`.
Note:
- If task name is `anli-full`, it will be trained with both adversarial and benign dataset (ANLI(train) + SNLI + MNLI + FeverNLI).
- If task name is `anli-part`, it will be trained with only benign dataset (SNLI + MNLI).
- The default MI estimator version is 6, which means both regularizers will be enabled.
- By default, `setup.sh` will use 1 GPU for training. If equipped with multiple GPUs, please modify the `setup.sh` and  set `--nproc_per_node=[ngpus]` accordingly.
- Our script can stop at any time and automatically resume from exisitng checkpoints.   

## Evaluate
We provide our [InfoBERT checkpoint](https://drive.google.com/file/d/1RljMLLuIUD4lFwjciX7gxBC7RxvlGMDy/view?usp=sharing) that achieves the state-of-the-art performance on the ANLI test dataset. 

To evaluate your model from a checkpoint
```bash
source setup.sh && evalexp  [results-dir] [checkpoint-dir]
```

For example, to evaluate our checkpoint performance
```bash
source setup.sh && evalexp  best-infobert infobert-checkpoint
```

The output should be like

```
01/13/2021 12:37:05 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:37:05 - INFO - local_robust_trainer -     Num examples = 3200
01/13/2021 12:37:05 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 400/400 [00:17<00:00, 22.72it/s]
{"eval_loss": 1.4944478544429876, "eval_acc": 0.5825, "eval_mi_info": 40.253395080566406, "step": null}
01/13/2021 12:37:23 - INFO - **main** -   ***** Eval results anli-full-dev *****
01/13/2021 12:37:23 - INFO - **main** -     eval_loss = 1.4944478544429876
01/13/2021 12:37:23 - INFO - **main** -     eval_acc = 0.5825
01/13/2021 12:37:23 - INFO - **main** -     eval_mi_info = 40.253395080566406
01/13/2021 12:37:23 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:37:23 - INFO - local_robust_trainer -     Num examples = 3200
01/13/2021 12:37:23 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 400/400 [00:17<00:00, 23.19it/s]
{"eval_loss": 1.5127741410769522, "eval_acc": 0.583125, "eval_mi_info": 40.0756950378418, "step": null}
01/13/2021 12:37:40 - INFO - **main** -   ***** Eval results anli-full-test *****
01/13/2021 12:37:40 - INFO - **main** -     eval_loss = 1.5127741410769522
01/13/2021 12:37:40 - INFO - **main** -     eval_acc = 0.583125
01/13/2021 12:37:40 - INFO - **main** -     eval_mi_info = 40.0756950378418
01/13/2021 12:37:40 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:37:40 - INFO - local_robust_trainer -     Num examples = 1000
01/13/2021 12:37:40 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 125/125 [00:05<00:00, 22.57it/s]
{"eval_loss": 0.8243400501683354, "eval_acc": 0.764, "eval_mi_info": 41.68259048461914, "step": null}
01/13/2021 12:37:46 - INFO - **main** -   ***** Eval results anli-r1-dev *****
01/13/2021 12:37:46 - INFO - **main** -     eval_loss = 0.8243400501683354
01/13/2021 12:37:46 - INFO - **main** -     eval_acc = 0.764
01/13/2021 12:37:46 - INFO - **main** -     eval_mi_info = 41.68259048461914
01/13/2021 12:37:46 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:37:46 - INFO - local_robust_trainer -     Num examples = 1000
01/13/2021 12:37:46 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 125/125 [00:05<00:00, 22.62it/s]
{"eval_loss": 0.8654105467200279, "eval_acc": 0.755, "eval_mi_info": 41.359413146972656, "step": null}
01/13/2021 12:37:51 - INFO - **main** -   ***** Eval results anli-r1-test *****
01/13/2021 12:37:51 - INFO - **main** -     eval_loss = 0.8654105467200279
01/13/2021 12:37:51 - INFO - **main** -     eval_acc = 0.755
01/13/2021 12:37:51 - INFO - **main** -     eval_mi_info = 41.359413146972656
01/13/2021 12:37:51 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:37:51 - INFO - local_robust_trainer -     Num examples = 1000
01/13/2021 12:37:51 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 125/125 [00:05<00:00, 22.82it/s]
{"eval_loss": 1.6665315675735473, "eval_acc": 0.517, "eval_mi_info": 41.185367584228516, "step": null}
01/13/2021 12:37:57 - INFO - **main** -   ***** Eval results anli-r2-dev *****
01/13/2021 12:37:57 - INFO - **main** -     eval_loss = 1.6665315675735473
01/13/2021 12:37:57 - INFO - **main** -     eval_acc = 0.517
01/13/2021 12:37:57 - INFO - **main** -     eval_mi_info = 41.185367584228516
01/13/2021 12:37:57 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:37:57 - INFO - local_robust_trainer -     Num examples = 1000
01/13/2021 12:37:57 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 125/125 [00:05<00:00, 22.74it/s]
{"eval_loss": 1.682003709077835, "eval_acc": 0.514, "eval_mi_info": 41.24909210205078, "step": null}
01/13/2021 12:38:02 - INFO - **main** -   ***** Eval results anli-r2-test *****
01/13/2021 12:38:02 - INFO - **main** -     eval_loss = 1.682003709077835
01/13/2021 12:38:02 - INFO - **main** -     eval_acc = 0.514
01/13/2021 12:38:02 - INFO - **main** -     eval_mi_info = 41.24909210205078
01/13/2021 12:38:02 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:38:02 - INFO - local_robust_trainer -     Num examples = 1200
01/13/2021 12:38:02 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 150/150 [00:06<00:00, 23.77it/s]
{"eval_loss": 1.909467930396398, "eval_acc": 0.48583333333333334, "eval_mi_info": 38.28575897216797, "step": null}
01/13/2021 12:38:08 - INFO - **main** -   ***** Eval results anli-r3-dev *****
01/13/2021 12:38:08 - INFO - **main** -     eval_loss = 1.909467930396398
01/13/2021 12:38:08 - INFO - **main** -     eval_acc = 0.48583333333333334
01/13/2021 12:38:08 - INFO - **main** -     eval_mi_info = 38.28575897216797
01/13/2021 12:38:08 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:38:08 - INFO - local_robust_trainer -     Num examples = 1200
01/13/2021 12:38:08 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 150/150 [00:06<00:00, 23.85it/s]
{"eval_loss": 1.9112191630403201, "eval_acc": 0.4975, "eval_mi_info": 38.02809524536133, "step": null}
01/13/2021 12:38:15 - INFO - **main** -   ***** Eval results anli-r3-test *****
01/13/2021 12:38:15 - INFO - **main** -     eval_loss = 1.9112191630403201
01/13/2021 12:38:15 - INFO - **main** -     eval_acc = 0.4975
01/13/2021 12:38:15 - INFO - **main** -     eval_mi_info = 38.02809524536133
01/13/2021 12:38:15 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:38:15 - INFO - local_robust_trainer -     Num examples = 9815
01/13/2021 12:38:15 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1227/1227 [00:41<00:00, 29.85it/s]
{"eval_loss": 0.3075757020476829, "eval_acc": 0.9108507386653082, "eval_mi_info": 33.53987121582031, "step": null}
01/13/2021 12:38:56 - INFO - **main** -   ***** Eval results mnli-dev *****
01/13/2021 12:38:56 - INFO - **main** -     eval_loss = 0.3075757020476829
01/13/2021 12:38:56 - INFO - **main** -     eval_acc = 0.9108507386653082
01/13/2021 12:38:56 - INFO - **main** -     eval_mi_info = 33.53987121582031
01/13/2021 12:38:56 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:38:56 - INFO - local_robust_trainer -     Num examples = 9832
01/13/2021 12:38:56 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1229/1229 [00:41<00:00, 29.60it/s]
{"eval_loss": 0.325766117048493, "eval_acc": 0.9070382424735557, "eval_mi_info": 33.497161865234375, "step": null}
01/13/2021 12:39:37 - INFO - **main** -   ***** Eval results mnli-mm-dev *****
01/13/2021 12:39:37 - INFO - **main** -     eval_loss = 0.325766117048493
01/13/2021 12:39:37 - INFO - **main** -     eval_acc = 0.9070382424735557
01/13/2021 12:39:37 - INFO - **main** -     eval_mi_info = 33.497161865234375
01/13/2021 12:39:37 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:39:37 - INFO - local_robust_trainer -     Num examples = 9842
01/13/2021 12:39:37 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1231/1231 [00:40<00:00, 30.69it/s]
{"eval_loss": 0.22175195821680835, "eval_acc": 0.9312131680552733, "eval_mi_info": 26.011133193969727, "step": null}
01/13/2021 12:40:17 - INFO - **main** -   ***** Eval results snli-dev *****
01/13/2021 12:40:17 - INFO - **main** -     eval_loss = 0.22175195821680835
01/13/2021 12:40:17 - INFO - **main** -     eval_acc = 0.9312131680552733
01/13/2021 12:40:17 - INFO - **main** -     eval_mi_info = 26.011133193969727
01/13/2021 12:40:17 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:40:17 - INFO - local_robust_trainer -     Num examples = 772
01/13/2021 12:40:17 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 97/97 [00:03<00:00, 29.60it/s]
{"eval_loss": 0.9281529402840383, "eval_acc": 0.7202072538860104, "eval_mi_info": 35.50751495361328, "step": null}
01/13/2021 12:40:21 - INFO - **main** -   ***** Eval results mnli-bert-adv-dev *****
01/13/2021 12:40:21 - INFO - **main** -     eval_loss = 0.9281529402840383
01/13/2021 12:40:21 - INFO - **main** -     eval_acc = 0.7202072538860104
01/13/2021 12:40:21 - INFO - **main** -     eval_mi_info = 35.50751495361328
01/13/2021 12:40:21 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:40:21 - INFO - local_robust_trainer -     Num examples = 746
01/13/2021 12:40:21 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:03<00:00, 29.64it/s]
{"eval_loss": 1.023387150561556, "eval_acc": 0.6983914209115282, "eval_mi_info": 35.46954345703125, "step": null}
01/13/2021 12:40:24 - INFO - **main** -   ***** Eval results mnli-mm-bert-adv-dev *****
01/13/2021 12:40:24 - INFO - **main** -     eval_loss = 1.023387150561556
01/13/2021 12:40:24 - INFO - **main** -     eval_acc = 0.6983914209115282
01/13/2021 12:40:24 - INFO - **main** -     eval_mi_info = 35.46954345703125
01/13/2021 12:40:24 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:40:24 - INFO - local_robust_trainer -     Num examples = 848
01/13/2021 12:40:24 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 106/106 [00:03<00:00, 30.65it/s]
{"eval_loss": 1.2708790726819128, "eval_acc": 0.5955188679245284, "eval_mi_info": 28.26164436340332, "step": null}
01/13/2021 12:40:27 - INFO - **main** -   ***** Eval results snli-bert-adv-dev *****
01/13/2021 12:40:27 - INFO - **main** -     eval_loss = 1.2708790726819128
01/13/2021 12:40:27 - INFO - **main** -     eval_acc = 0.5955188679245284
01/13/2021 12:40:27 - INFO - **main** -     eval_mi_info = 28.26164436340332
01/13/2021 12:40:27 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:40:27 - INFO - local_robust_trainer -     Num examples = 775
01/13/2021 12:40:27 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 97/97 [00:03<00:00, 29.61it/s]
{"eval_loss": 1.4205392347168677, "eval_acc": 0.5367741935483871, "eval_mi_info": 35.69055938720703, "step": null}
01/13/2021 12:40:31 - INFO - **main** -   ***** Eval results mnli-roberta-adv-dev *****
01/13/2021 12:40:31 - INFO - **main** -     eval_loss = 1.4205392347168677
01/13/2021 12:40:31 - INFO - **main** -     eval_acc = 0.5367741935483871
01/13/2021 12:40:31 - INFO - **main** -     eval_mi_info = 35.69055938720703
01/13/2021 12:40:31 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:40:31 - INFO - local_robust_trainer -     Num examples = 775
01/13/2021 12:40:31 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 97/97 [00:03<00:00, 29.47it/s]
{"eval_loss": 1.367013628949824, "eval_acc": 0.5703225806451613, "eval_mi_info": 35.5481071472168, "step": null}
01/13/2021 12:40:34 - INFO - **main** -   ***** Eval results mnli-mm-roberta-adv-dev *****
01/13/2021 12:40:34 - INFO - **main** -     eval_loss = 1.367013628949824
01/13/2021 12:40:34 - INFO - **main** -     eval_acc = 0.5703225806451613
01/13/2021 12:40:34 - INFO - **main** -     eval_mi_info = 35.5481071472168
01/13/2021 12:40:34 - INFO - local_robust_trainer -   ***** Running Evaluation *****
01/13/2021 12:40:34 - INFO - local_robust_trainer -     Num examples = 836
01/13/2021 12:40:34 - INFO - local_robust_trainer -     Batch size = 8
Evaluation: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 105/105 [00:03<00:00, 30.71it/s]
{"eval_loss": 1.7491175064018794, "eval_acc": 0.42105263157894735, "eval_mi_info": 28.207780838012695, "step": null}
01/13/2021 12:40:37 - INFO - **main** -   ***** Eval results snli-roberta-adv-dev *****
01/13/2021 12:40:37 - INFO - **main** -     eval_loss = 1.7491175064018794
01/13/2021 12:40:37 - INFO - **main** -     eval_acc = 0.42105263157894735
01/13/2021 12:40:37 - INFO - **main** -     eval_mi_info = 28.207780838012695

```